<script setup>
import { onMounted, ref, provide, watch } from 'vue'
import { RouterView } from 'vue-router'
import SideBar from './components/SideBar.vue'
import Toast from './components/Toast.vue'
import Login from './components/Login.vue'
import Signup from './components/Signup.vue'


const sideBarState = ref(false)
const sidebarfeatures = ref([])
const toastConfig = ref({
  show: false,
  message: '',
  type: 'info'
})

const fetchData = async (endpoint, stateRef) => {
  try {
    const token = localStorage.getItem('access_token');
    if (!token) throw new Error('User not authenticated');
    const res = await fetch(`https://production2.swancapital.in/${endpoint}`, {
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
    });
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    if (endpoint === 'sidebar-features') {
      // If data is an array, convert it to the expected format
      if (Array.isArray(data)) {
        // Determine the role based on the features
        const role = data.includes('Admin Panel') ? 'Admin' :
                    data.includes('Client Page') ? 'Client' :
                    data.includes('Monitor') ? 'Monitor' : 'Default';
        
        // Create the role-based object
        stateRef.value = {
          [role]: data
        };
      } else {
        // If data is already in the correct format, use it as is
        stateRef.value = data;
      }
      console.log('Processed sidebar features:', stateRef.value);
    } else {
      stateRef.value = endpoint === 'getAccounts' ? Object.keys(data) : data || [];
    }
  } catch (err) {
    console.error(`Error fetching ${endpoint}:`, err.message);
  }
};

const ChangeSideBarState = (data) => {
  sideBarState.value = data
}

const triggerToast = (message, type = 'info') => {

  // Get current time
  const now = new Date();
  const hour = now.getHours();    // 0-23 (e.g., 15 = 3 PM)
  const minute = now.getMinutes(); // 0-59

  // Check if after 9:00 AM AND before 3:30 PM
  const withinBusinessHours = 
    (hour > 9 || (hour === 9 && minute >= 0)) && 
    (hour < 15 || (hour === 15 && minute < 30));

    console.log(withinBusinessHours,"  is the withinbusinesshours")
  if (withinBusinessHours) {
   
    toastConfig.value = {
      show: true,
      message,
      type
    }
  }



}

const hideToast = () => {
  toastConfig.value.show = false
}


const showloginorSignup = ref(false)
const isLoggedIn = ref(false) // Add a ref to track login state

const toggleForm = () => {
  showloginorSignup.value = !showloginorSignup.value;
}
const checkLoginStatus = () => {
  const token = localStorage.getItem('access_token'); // Check if the access token is stored
  isLoggedIn.value = !!token; // Set isLoggedIn to true if token exists, false otherwise
};


const book = ref({})
const past_time_client = ref(0)
const client_latency = ref(0)
const max_client_latency = ref(0)

const handleMessage = (message) => {
  try {
    if (message === undefined) return;
    book.value['time'] = message["time"]

    if (book.value['Order_Errors']) {
      for (const key in book.value['Order_Errors']) {
        if (book.value['Order_Errors'][key].length != message['Order_Errors'][key].length) {
          triggerToast('New Error in Order', 'error')
        }
      }
    }

    book.value['Order_Errors'] = message['Order_Errors']

    if (book.value['Pulse_Errors']) {
      for (const key in book.value['Pulse_Errors']) {
        if (book.value['Pulse_Errors'][key].length != message['Pulse_Errors'][key].length) {
          triggerToast('New Error in ' + key, 'error')
        }
      }

    }
    book.value['Pulse_Errors'] = message['Pulse_Errors']

  } catch (error) {
    console.error('Error parsing event data or updating data:', error);
  }
}

const connectToSSE = () => {
  const token = localStorage.getItem('access_token'); // Retrieve the access token
    if (!token ) {
        if(isLoggedIn.value)alert('User not authenticated To Get Errors');
        return;
    }
    
  const socket = new WebSocket('wss://production2.swancapital.in/errorLogs');

  socket.onmessage = (event) => {
    if (event.data === 'ping') {
      socket.send('pong')
    } else {
      const message = JSON.parse(event.data);
      let ar2 = message["time"];
      if (past_time_client.value === 0) past_time_client.value = ar2;
      // if (past_time_client.value != 0) {
      //   let date1 = new Date(past_time_client.value.replace(/(\d{2})-(\d{2})-(\d{4})/, '$3-$2-$1'));
      //   let date2 = new Date(ar2.replace(/(\d{2})-(\d{2})-(\d{4})/, '$3-$2-$1'));
      //   let diffInMs = date2 - date1;
      //   let diffInSeconds = diffInMs / 1000;
      //   client_latency.value = diffInSeconds;
      //   max_client_latency.value = Math.max(max_client_latency.value, client_latency.value)
      //   past_time_client.value = ar2;
      // }

      handleMessage(message)
    }
  }
  socket.onclose = (event) => {
    console.log('WebSocket connection closed:', event.reason)
  }

  socket.onopen = () => {
   
    const authMessage = JSON.stringify({ token });
    socket.send(authMessage);
    console.log('WebSocket connection opened')
  }
  socket.onerror = (error) => {
    console.error('WebSocket error:', error)
  }
};

const fetchSidebarFeatures = () => fetchData('sidebar-features', sidebarfeatures);

onMounted(() => {
  connectToSSE();
  checkLoginStatus();
  fetchSidebarFeatures();

  // triggerToast('New Error in Order', 'error')
})

provide('triggerToast', triggerToast)
provide('book', book.value)



</script>

<template>
  <div class="pageLayout">
    <Signup v-if="!isLoggedIn && showloginorSignup" @toggleForm="toggleForm" />
    <Login v-if="!isLoggedIn && !showloginorSignup" @toggleForm="toggleForm" />


    <SideBar v-if="isLoggedIn" @State="ChangeSideBarState" :sidebarfeatures="sidebarfeatures" class="sideBar" />
    <Toast v-if="toastConfig.show && isLoggedIn" :message="toastConfig.message" :type="toastConfig.type" @close="hideToast" />
   
    <RouterView v-if="isLoggedIn" :class="sideBarState ? 'content' : 'content2'" />

  </div>
</template>

<style scoped>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

body {
  margin: 0;
  font-family: "Inter", sans-serif;
  width: 100%;
  height: 100%;
}

.pageLayout {
  display: flex;
  height: 100%;
}

.sideBar {
  position: fixed;
  width: fit-content;
  height: 100%;
}

.content {
  margin-left: 100px;
  width: calc(100% - 100px);
  height: 100%;
  transition: all 0.3s;
}

.content2 {
  margin-left: 250px;
  width: calc(100% - 250px);
  height: 100%;
  transition: all 0.3s;
}
</style>